<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ - ãƒ‡ãƒ¢ç‰ˆ</title>
  <style>
    :root {
      --primary-color: #4a5568;
      --accent-color: #667eea;
      --bg-gradient-start: #2a2a72;
      --bg-gradient-end: #009ffd;
      --card-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px 10px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #edf2f7;
    }

    .tab-btn {
      flex: 1;
      padding: 15px;
      text-align: center;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      color: #a0aec0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      color: var(--accent-color);
      border-bottom: 3px solid var(--accent-color);
    }

    .tab-content {
      display: none;
      padding: 30px 20px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #4a5568;
    }

    input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 1rem;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
    }

    .checkbox-item input {
      margin-right: 8px;
      transform: scale(1.2);
    }

    button.submit-btn {
      width: 100%;
      padding: 15px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }

    button.submit-btn:hover {
      background: #5a67d8;
    }

    button.submit-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }

    /* AI Advice Display Styles */
    #advice-display {
      margin-top: 30px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 5px solid var(--accent-color);
      display: none;
    }

    .advice-section {
      margin-bottom: 20px;
    }

    .advice-title {
      color: var(--accent-color);
      border-bottom: 2px solid #edf2f7;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }

    .schedule-list, .priority-list {
      list-style: none;
    }

    .schedule-item, .priority-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .priority-high { border-left: 4px solid #e53e3e; }
    .priority-medium { border-left: 4px solid #ed8936; }
    .priority-low { border-left: 4px solid #48bb78; }

    .loader {
      text-align: center;
      display: none;
      margin: 20px 0;
    }
    .loader-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸŒ™ ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</h1>
    <p>é‡å­Ã—ç”ŸæˆAIã«ã‚ˆã‚‹ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºç¡çœ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('basic')">1. åŸºæœ¬æƒ…å ±</button>
    <button class="tab-btn" onclick="switchTab('daily')">2. æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
  </div>

  <div id="tab-basic" class="tab-content active">
    <div class="form-group">
      <label>ãŠåå‰</label>
      <input type="text" id="b-name" value="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼">
    </div>
    <div class="form-group">
      <label>ç”Ÿå¹´æœˆæ—¥</label>
      <div style="display:flex; gap:8px;">
        <select id="b-birthdate-year" style="flex:3;">
          <option value="">å¹´</option>
        </select>
        <select id="b-birthdate-month" onchange="updateBirthdateDays()" style="flex:2;">
          <option value="">æœˆ</option>
          <option value="01">1æœˆ</option>
          <option value="02">2æœˆ</option>
          <option value="03">3æœˆ</option>
          <option value="04">4æœˆ</option>
          <option value="05">5æœˆ</option>
          <option value="06">6æœˆ</option>
          <option value="07">7æœˆ</option>
          <option value="08">8æœˆ</option>
          <option value="09">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
        <select id="b-birthdate-day" style="flex:2;">
          <option value="">æ—¥</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>æ€§åˆ¥</label>
      <select id="b-gender">
        <option value="ç”·æ€§">ç”·æ€§</option>
        <option value="å¥³æ€§">å¥³æ€§</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
    </div>
    <div class="form-group">
      <label>è·æ¥­ãƒ»è·ç¨®</label>
      <input type="text" id="b-occupation" value="ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯ä¸­å¿ƒ">
    </div>
    <div class="form-group">
      <label>æ™®æ®µã®å¹³å‡èµ·åºŠæ™‚åˆ»</label>
      <input type="time" id="b-avgWake" value="06:30">
    </div>
    <div class="form-group">
      <label>ç¡çœ ã«é–¢ã™ã‚‹ä¸»ãªæ‚©ã¿ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="checkbox-group" id="b-concerns">
        <label class="checkbox-item"><input type="checkbox" value="å¯ä»˜ããŒæ‚ªã„"> å¯ä»˜ããŒæ‚ªã„</label>
        <label class="checkbox-item"><input type="checkbox" value="å¤œä¸­ã«ç›®ãŒè¦šã‚ã‚‹" checked> å¤œä¸­ã«ç›®ãŒè¦šã‚ã‚‹</label>
        <label class="checkbox-item"><input type="checkbox" value="æœã™ã£ãã‚Šèµ·ãã‚‰ã‚Œãªã„"> æœã™ã£ãã‚Šèµ·ãã‚‰ã‚Œãªã„</label>
        <label class="checkbox-item"><input type="checkbox" value="æ—¥ä¸­çœ ã„" checked> æ—¥ä¸­çœ ã„</label>
      </div>
    </div>
    <button class="submit-btn" onclick="saveBasicInfo()">åŸºæœ¬æƒ…å ±ã‚’ä¿å­˜ã—ã¦æ¬¡ã¸</button>
  </div>

  <div id="tab-daily" class="tab-content">
    <div class="form-group">
      <label>ä»Šæœã®èµ·åºŠæ™‚åˆ»</label>
      <input type="time" id="d-wakeTime" value="06:45">
    </div>
    <div class="form-group">
      <label>æœ¬æ—¥ã®ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å–</label>
      <select id="d-caffeine">
        <option value="ãªã—">ãªã—</option>
        <option value="ã‚ã‚Šï¼ˆåˆå‰ã®ã¿ï¼‰">ã‚ã‚Šï¼ˆåˆå‰ã®ã¿ï¼‰</option>
        <option value="ã‚ã‚Šï¼ˆåˆå¾Œã‚‚ï¼‰" selected>ã‚ã‚Šï¼ˆåˆå¾Œã‚‚ï¼‰</option>
      </select>
    </div>
    <div class="form-group">
      <label>æœ€å¾Œã«ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã‚’æ‘‚ã£ãŸæ™‚é–“</label>
      <input type="time" id="d-caffeineTime" value="16:00">
    </div>
    <div class="form-group">
      <label>æœ¬æ—¥ã®é‹å‹•é‡</label>
      <select id="d-exercise">
        <option value="ã»ã¨ã‚“ã©ã—ã¦ã„ãªã„">ã»ã¨ã‚“ã©ã—ã¦ã„ãªã„</option>
        <option value="è»½ã„é‹å‹•ï¼ˆã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ç­‰ï¼‰" selected>è»½ã„é‹å‹•ï¼ˆã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ç­‰ï¼‰</option>
        <option value="æ¿€ã—ã„é‹å‹•">æ¿€ã—ã„é‹å‹•</option>
      </select>
    </div>
    <div class="form-group">
      <label>æœ¬æ—¥ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ï¼ˆ1:ä½ã„ ã€œ 5:é«˜ã„ï¼‰</label>
      <select id="d-stress">
        <option value="1">1</option><option value="2">2</option>
        <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
      </select>
    </div>
    <div class="form-group">
      <label>æœ¬æ—¥ã®ç–²åŠ´æ„Ÿï¼ˆ1:ä½ã„ ã€œ 5:é«˜ã„ï¼‰</label>
      <select id="d-fatigue">
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4" selected>4</option><option value="5">5</option>
      </select>
    </div>
    
    <button class="submit-btn" id="generate-btn" onclick="generateAdvice()">AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã«ç›¸è«‡ã™ã‚‹</button>

    <div class="loader" id="loading-indicator">
      <div class="loader-spinner"></div>
      <p style="margin-top: 10px; color: #666;">ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã€æœ€é©ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆä¸­...</p>
    </div>

    <div id="advice-display">
      </div>
  </div>
</div>

<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åŸºæœ¬æƒ…å ±ã‚’ä¿æŒï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
  let savedBasicInfo = null;

  // ============================================================
  // ç”Ÿå¹´æœˆæ—¥ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–ãƒ»æ“ä½œ
  // ============================================================

  // å¹´ã‚»ãƒ¬ã‚¯ãƒˆã« 1930ã€œç¾åœ¨å¹´ ã‚’é™é †ã§è¿½åŠ ã™ã‚‹
  function initBirthdateSelects() {
    const yearSelect  = document.getElementById('b-birthdate-year');
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= 1930; y--) {
      const opt = document.createElement('option');
      opt.value       = String(y);
      opt.textContent = `${y}å¹´`;
      yearSelect.appendChild(opt);
    }
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ 1980å¹´1æœˆ1æ—¥ ã‚’è¨­å®š
    yearSelect.value = '1980';
    document.getElementById('b-birthdate-month').value = '01';
    updateBirthdateDays();
    document.getElementById('b-birthdate-day').value = '01';
  }

  // é¸æŠã•ã‚ŒãŸå¹´ãƒ»æœˆã«å¿œã˜ã¦æ—¥ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°ã™ã‚‹ï¼ˆã†ã‚‹ã†å¹´å¯¾å¿œï¼‰
  function updateBirthdateDays() {
    const yearVal   = document.getElementById('b-birthdate-year').value;
    const monthVal  = document.getElementById('b-birthdate-month').value;
    const daySelect = document.getElementById('b-birthdate-day');
    const prevDay   = daySelect.value;

    const year  = parseInt(yearVal)  || 2000;
    const month = parseInt(monthVal) || 1;
    const daysInMonth = new Date(year, month, 0).getDate();

    daySelect.innerHTML = '<option value="">æ—¥</option>';
    for (let d = 1; d <= daysInMonth; d++) {
      const opt = document.createElement('option');
      opt.value       = String(d).padStart(2, '0');
      opt.textContent = `${d}æ—¥`;
      daySelect.appendChild(opt);
    }
    if (prevDay && parseInt(prevDay) <= daysInMonth) {
      daySelect.value = prevDay;
    }
  }

  // å¹´ãƒ»æœˆãƒ»æ—¥ã‚»ãƒ¬ã‚¯ãƒˆã‹ã‚‰ "YYYY-MM-DD" å½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
  function getBirthdateValue() {
    const year  = document.getElementById('b-birthdate-year').value;
    const month = document.getElementById('b-birthdate-month').value;
    const day   = document.getElementById('b-birthdate-day').value;
    return (year && month && day) ? `${year}-${month}-${day}` : '';
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¹´ã‚»ãƒ¬ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹
  window.addEventListener('DOMContentLoaded', initBirthdateSelects);

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
  function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if(tabId === 'basic') {
      document.querySelectorAll('.tab-btn')[0].classList.add('active');
      document.getElementById('tab-basic').classList.add('active');
    } else {
      document.querySelectorAll('.tab-btn')[1].classList.add('active');
      document.getElementById('tab-daily').classList.add('active');
    }
  }

  // 1. åŸºæœ¬æƒ…å ±ã®ä¿å­˜ï¼ˆFastAPIã¸é€ä¿¡ï¼‰
  async function saveBasicInfo() {
    const checkboxes = document.querySelectorAll('#b-concerns input:checked');
    const concerns = Array.from(checkboxes).map(cb => cb.value);

    const birthdate = getBirthdateValue();
    if (!birthdate) {
      alert('ç”Ÿå¹´æœˆæ—¥ã®å¹´ãƒ»æœˆãƒ»æ—¥ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    savedBasicInfo = {
      name: document.getElementById('b-name').value,
      birthdate: birthdate,
      gender: document.getElementById('b-gender').value,
      height: 170.0, // UIçœç•¥åˆ†ãƒ¢ãƒƒã‚¯
      weight: 65.0,  // UIçœç•¥åˆ†ãƒ¢ãƒƒã‚¯
      occupation: document.getElementById('b-occupation').value,
      avgWakeTime: document.getElementById('b-avgWake').value,
      sleepConcerns: concerns
    };

    try {
      const response = await fetch('/api/save_basic_info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(savedBasicInfo)
      });
      const result = await response.json();
      
      if(result.success) {
        alert('åŸºæœ¬æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›ã«é€²ã¿ã¾ã™ã€‚');
        switchTab('daily');
      }
    } catch (error) {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      console.error(error);
    }
  }

  // 2. æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã¨AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—
  async function generateAdvice() {
    if (!savedBasicInfo) {
      alert('å…ˆã«åŸºæœ¬æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
      switchTab('basic');
      return;
    }

    const dailyData = {
      wakeTime: document.getElementById('d-wakeTime').value,
      breakfast: "ã‚ã‚Š", // UIçœç•¥åˆ†ãƒ¢ãƒƒã‚¯
      breakfastTime: "07:30",
      exercise: document.getElementById('d-exercise').value,
      caffeine: document.getElementById('d-caffeine').value,
      caffeineTime: document.getElementById('d-caffeineTime').value,
      nap: "ãªã—",
      napDuration: 0,
      dinnerTime: "19:30",
      dinnerContent: "æ™®é€š",
      eveningExercise: "ãªã—",
      stress: parseInt(document.getElementById('d-stress').value),
      fatigue: parseInt(document.getElementById('d-fatigue').value)
    };

    const requestBody = {
      basicInfo: savedBasicInfo,
      dailyData: dailyData
    };

    // UIçŠ¶æ…‹ã®æ›´æ–°ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
    const btn = document.getElementById('generate-btn');
    const loader = document.getElementById('loading-indicator');
    const display = document.getElementById('advice-display');
    
    btn.disabled = true;
    loader.style.display = 'block';
    display.style.display = 'none';

    try {
      const response = await fetch('/api/generate_advice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });
      const result = await response.json();

      if (result.success) {
        renderAdvice(result.advice);
      } else {
        alert('APIã‚¨ãƒ©ãƒ¼: ' + result.message);
      }
    } catch (error) {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ã¾ã›ã‚“ã€‚');
      console.error(error);
    } finally {
      btn.disabled = false;
      loader.style.display = 'none';
    }
  }

  // 3. AIã‚¢ãƒ‰ãƒã‚¤ã‚¹çµæœã®DOMãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  function renderAdvice(advice) {
    const display = document.getElementById('advice-display');
    
    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
    let scheduleHTML = '';
    if(advice.sleep_schedule && advice.sleep_schedule.length > 0) {
      scheduleHTML = '<ul class="schedule-list">';
      advice.sleep_schedule.forEach(item => {
        scheduleHTML += `<li class="schedule-item"><strong>${item.time}</strong> - ${item.action}</li>`;
      });
      scheduleHTML += '</ul>';
    }

    // å„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ
    let priorityHTML = '';
    if(advice.priority_advice && advice.priority_advice.length > 0) {
      priorityHTML = '<ul class="priority-list">';
      advice.priority_advice.forEach(item => {
        const priorityClass = item.priority === 'é«˜' ? 'priority-high' : (item.priority === 'ä¸­' ? 'priority-medium' : 'priority-low');
        priorityHTML += `
          <li class="priority-item ${priorityClass}">
            <h4>${item.icon || 'ğŸ’¡'} ${item.title} (å„ªå…ˆåº¦: ${item.priority})</h4>
            <p><strong>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> ${item.action}</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">${item.reason}</p>
          </li>
        `;
      });
      priorityHTML += '</ul>';
    }

    // å…¨ä½“ã®HTMLçµ„ã¿ç«‹ã¦
    display.innerHTML = `
      <div class="advice-section">
        <h2 style="color: #2a2a72; margin-bottom: 10px;">${advice.greeting}</h2>
        <p>${advice.today_summary}</p>
      </div>

      <div class="advice-section">
        <h3 class="advice-title">ğŸ•’ ä»Šå¤œã®æ¨å¥¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
        <p style="margin-bottom: 10px;"><strong>ç›®æ¨™å°±å¯æ™‚åˆ»: ${advice.recommended_bedtime}</strong></p>
        ${scheduleHTML}
      </div>

      <div class="advice-section">
        <h3 class="advice-title">ğŸ¯ å„ªå…ˆã™ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        ${priorityHTML}
      </div>

      ${advice.sleep_prediction ? `
      <div class="advice-section" style="background: #e2e8f0; padding: 15px; border-radius: 8px;">
        <h3 style="margin-bottom: 5px;">ğŸ“Š æ˜æ—¥ã®ç¡çœ äºˆæ¸¬ã‚¹ã‚³ã‚¢: ${advice.sleep_prediction.quality_score} / 100</h3>
        <p>${advice.sleep_prediction.comment}</p>
      </div>
      ` : ''}

      <div style="text-align: center; margin-top: 20px; font-weight: bold; color: var(--accent-color);">
        ${advice.encouragement}
      </div>
    `;
    
    display.style.display = 'block';
  }
</script>

</body>
</html>