<!DOCTYPE html>
<!--
========================================================
ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒª - ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³å…¬é–‹ç‰ˆ
========================================================

æ¦‚è¦:
  Python ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸è¦ã€‚HTML 1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã§å‹•ä½œã€‚
  ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ Google Gemini API ã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦
  ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸç¡çœ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã€‚
  ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ»PC ã©ã¡ã‚‰ã«ã‚‚å¯¾å¿œã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³• (å¤–éƒ¨å…¬é–‹ / 1é€±é–“ä»¥ä¸Šã®è©•ä¾¡æœŸé–“ã«å¯¾å¿œ):
  â”€â”€ æ–¹æ³•A: GitHub Pagesï¼ˆç„¡æ–™ãƒ»æ°¸ç¶šãƒ»æ¨å¥¨ï¼‰â”€â”€
  1. https://github.com ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆç„¡æ–™ï¼‰
  2. æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆï¼ˆPublicï¼‰
  3. ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œindex.htmlã€ã¨ã„ã†åå‰ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  4. Settings â†’ Pages â†’ Source: main branch â†’ Save
  5. URL: https://ãƒ¦ãƒ¼ã‚¶ãƒ¼å.github.io/ãƒªãƒã‚¸ãƒˆãƒªå/

  â”€â”€ æ–¹æ³•B: Netlifyï¼ˆç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ°¸ç¶šï¼‰ â”€â”€
  1. https://app.netlify.com ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆç„¡æ–™ï¼‰
  2. Sites â†’ Add new site â†’ Deploy manually
  3. ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
  4. URL: https://ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—.netlify.app (æ°¸ç¶š)
  â€» ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—ã® Drop ã¯1æ™‚é–“ã§æ¶ˆãˆã‚‹ãŸã‚è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

ãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèªæ–¹æ³•:
  - ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥é–‹ãã ã‘ (Python ã‚µãƒ¼ãƒãƒ¼ä¸è¦)

ã‚¹ãƒãƒ›å¯¾å¿œ:
  - iOS Safari / Android Chrome ä¸¡å¯¾å¿œ
  - ã‚¿ãƒƒãƒæ“ä½œæœ€é©åŒ–æ¸ˆã¿
  - ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢è¨­å®šæ¸ˆã¿
  - iPhone ã®ãƒãƒƒãƒãƒ»ãƒ›ãƒ¼ãƒ ãƒãƒ¼å¯¾å¿œ (Safe Area)

ãƒ‡ãƒ¼ã‚¿ä¿å­˜:
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜
  - ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ã¯è¡Œã‚ãªã„ï¼ˆãƒ‡ãƒ¢ç”¨é€”ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼‰

Gemini API:
  - ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ REST API ã‚’ç›´æ¥å‘¼ã³å‡ºã™
  - ãƒ¢ãƒ‡ãƒ«: gemini-2.5-flash (é«˜é€Ÿãƒ»å®‰å®šãƒ»2.0-flashå¾Œç¶™)
========================================================
-->
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!-- ã‚¹ãƒãƒ›å¯¾å¿œ: initial-scale=1 ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å›ºå®šã€‚
       user-scalable=no ã¯ iOS ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚è¨­å®šã€‚
       viewport-fit=cover ã¯ iPhone ã®ãƒãƒƒãƒãƒ»Dynamic Island ã«å¯¾å¿œã™ã‚‹ã€‚ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- iOS ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸéš›ã«ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªé¢¨ã§è¡¨ç¤º -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥">

  <!-- Android Chrome ã§ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ æ™‚ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ -->
  <meta name="theme-color" content="#667eea">

  <!-- SNS ã‚·ã‚§ã‚¢æ™‚ã® OGP è¨­å®š -->
  <meta property="og:title" content="ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒª">
  <meta property="og:description" content="AIãŒã‚ãªãŸã®ç¡çœ ã‚’ç§‘å­¦çš„ã«ã‚µãƒãƒ¼ãƒˆã—ã¾ã™">

  <title>ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒª</title>

  <!-- ============================================================
       ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ
       ç´«ç³»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸãƒ¢ãƒã‚¤ãƒ«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ‡ã‚¶ã‚¤ãƒ³
       ============================================================ -->
  <style>
    /* å…¨è¦ç´ ã®ãƒãƒ¼ã‚¸ãƒ³ãƒ»ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ãƒšãƒ¼ã‚¸å…¨ä½“: ç´«ç³»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
       padding-bottom ã« env(safe-area-inset-bottom) ã‚’è¿½åŠ ã—ã¦
       iPhone ã®ãƒ›ãƒ¼ãƒ ãƒãƒ¼é ˜åŸŸã«è¢«ã‚‰ãªã„ã‚ˆã†å¯¾å¿œã™ã‚‹ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans',
                   'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      /* iPhone ãƒãƒƒãƒå¯¾å¿œ: ä¸Šä¸‹ã®å®‰å…¨é ˜åŸŸã‚’ç¢ºä¿ */
      padding: max(20px, env(safe-area-inset-top))
               20px
               max(20px, env(safe-area-inset-bottom))
               20px;
      /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ…£æ€§ã‚’æœ‰åŠ¹åŒ– */
      -webkit-overflow-scrolling: touch;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ: ç™½ã„ä¸¸è§’ã‚«ãƒ¼ãƒ‰ (æœ€å¤§å¹… 600px)
       ã‚¹ãƒãƒ›ã§ã¯å·¦å³ä½™ç™½ã‚’è©°ã‚ã¦ç”»é¢ã‚’åºƒãä½¿ã† */
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 24px 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    /* ã‚¹ãƒãƒ›å°ç”»é¢ (375pxä»¥ä¸‹) ã§ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
    @media (max-width: 375px) {
      .container { padding: 18px 15px; border-radius: 16px; }
    }

    /* ã‚¢ãƒ—ãƒªãƒ­ã‚´ãƒ»ã‚¿ã‚¤ãƒˆãƒ« */
    .logo { text-align: center; font-size: 3em; margin-bottom: 10px; }
    h1 { text-align: center; color: #667eea; margin-bottom: 10px; font-size: 1.4em; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9em; }

    /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
       ã‚¹ãƒãƒ›ã§æŠ¼ã—ã‚„ã™ã„ã‚ˆã† min-height ã‚’ç¢ºä¿ */
    .tab-buttons { display: flex; gap: 8px; margin-bottom: 24px; }
    .tab-btn {
      flex: 1;
      min-height: 50px;
      padding: 12px 8px;
      border: none;
      background: #f0f0f0; color: #666;
      border-radius: 12px; cursor: pointer;
      font-size: 0.95em; font-weight: bold;
      transition: all 0.3s;
      -webkit-tap-highlight-color: transparent;
      line-height: 1.3;
    }
    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102,126,234,0.35);
    }
    .tab-btn:active:not(.active) { background: #e0e0e0; }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯éè¡¨ç¤ºã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ãƒ•ã‚©ãƒ¼ãƒ å„é …ç›®ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 0.95em; }
    .required { color: #e74c3c; }

    /* ãƒ†ã‚­ã‚¹ãƒˆãƒ»æ—¥ä»˜ãƒ»æ•°å€¤ãƒ»ã‚»ãƒ¬ã‚¯ãƒˆã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ«
       font-size: 16px ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ iOS Safari ã®
       ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚è‡ªå‹•ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ã™ã‚‹ï¼ˆ16pxæœªæº€ã ã¨ã‚ºãƒ¼ãƒ ã•ã‚Œã‚‹ï¼‰ */
    input[type="text"], input[type="date"], input[type="number"],
    input[type="time"], select {
      width: 100%; padding: 13px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px; /* iOS ã‚ºãƒ¼ãƒ é˜²æ­¢ã®ãŸã‚ 16px å›ºå®š */
      color: #333; background: white;
      transition: border-color 0.2s;
      /* iOS ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè§’ä¸¸ã‚’ç„¡åŠ¹åŒ– */
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus {
      outline: none; border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ  (iOS/Android çµ±ä¸€) */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23667eea' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
       ã‚¹ãƒãƒ›ã§ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã† min-height ã‚’ç¢ºä¿ã—ã€
       ãƒ†ã‚­ã‚¹ãƒˆã‚‚å¤§ãã‚ã«è¨­å®š */
    .checkbox-group { display: flex; flex-direction: column; gap: 4px; }
    .checkbox-item {
      display: flex; align-items: center; gap: 12px;
      cursor: pointer;
      padding: 10px 8px;
      border-radius: 8px;
      min-height: 44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆæœ€å°ã‚µã‚¤ã‚ºç¢ºä¿ */
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .checkbox-item:hover { background: #f5f5ff; }
    .checkbox-item:active { background: #ebebff; }
    .checkbox-item input[type="checkbox"] {
      width: 22px; height: 22px;
      cursor: pointer;
      flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†å›ºå®š */
      accent-color: #667eea; /* ãƒã‚§ãƒƒã‚¯è‰²ã‚’ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã«çµ±ä¸€ */
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ (ãƒ¬ãƒ³ã‚¸å…¥åŠ›)
       ã‚¹ãƒãƒ›ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã‚„ã™ã„ã‚ˆã† height ã‚’å¤§ãã‚ã«è¨­å®š */
    .range-group { display: flex; align-items: center; gap: 12px; }
    input[type="range"] {
      flex: 1; cursor: pointer;
      height: 6px; /* ãƒˆãƒ©ãƒƒã‚¯ã®å¤ªã• */
      accent-color: #667eea; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è‰²ã‚’ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã«çµ±ä¸€ */
      -webkit-tap-highlight-color: transparent;
    }
    .range-value {
      min-width: 32px; text-align: center;
      font-weight: bold; color: #667eea; font-size: 1.2em;
    }

    /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ«
       min-height: 52px ã§ã‚¹ãƒãƒ›ã®ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ååˆ†ãªå¤§ãã•ã«ç¢ºä¿
       (Apple HIG / Google Material Design ã¨ã‚‚ã«æœ€å° 44ã€œ48px æ¨å¥¨) */
    .btn {
      width: 100%;
      min-height: 52px;
      padding: 14px 15px;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.02em;
      /* ã‚¿ãƒƒãƒæ“ä½œã§ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– (iOS) */
      -webkit-tap-highlight-color: transparent;
    }
    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    /* PC: ãƒ›ãƒãƒ¼æ™‚ã«æµ®ãä¸ŠãŒã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @media (hover: hover) {
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102,126,234,0.4);
      }
    }
    /* ã‚¹ãƒãƒ›: ã‚¿ãƒƒãƒ—æ™‚ã®æŠ¼ã—è¾¼ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .btn-primary:active:not(:disabled) {
      transform: scale(0.97);
      box-shadow: 0 2px 8px rgba(102,126,234,0.3);
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ãƒ»ã‚µã‚¯ã‚»ã‚¹ãƒœãƒƒã‚¯ã‚¹ãƒ»ã‚¨ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ */
    .info-box {
      background: #e8f4f8; border-left: 4px solid #3498db;
      padding: 15px; margin-bottom: 20px; border-radius: 5px;
      line-height: 1.6;
    }
    .success-box {
      background: #d4edda; border-left: 4px solid #28a745;
      padding: 15px; margin-bottom: 20px; border-radius: 5px;
      line-height: 1.6;
    }
    .error-box {
      background: #fde8e8; border-left: 4px solid #e74c3c;
      padding: 15px; margin-bottom: 20px; border-radius: 5px;
      line-height: 1.6;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ (AIç”Ÿæˆä¸­ã«è¡¨ç¤º) */
    .loading { text-align: center; padding: 40px; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%; width: 50px; height: 50px;
      animation: spin 1s linear infinite; margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading p { color: #666; line-height: 1.8; }

    /* ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .advice-container { margin-top: 30px; }
    .advice-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 25px 20px;
      border-radius: 10px 10px 0 0; text-align: center;
    }
    .advice-header h2 { font-size: 1.2em; line-height: 1.5; }
    .advice-body {
      background: #f8f9ff; padding: 20px;
      border-radius: 0 0 10px 10px;
    }

    /* æ¨å¥¨å°±å¯æ™‚åˆ» (å¤§ããå¼·èª¿è¡¨ç¤º) */
    .bedtime {
      text-align: center; font-size: 2.8em;
      color: #667eea; margin: 20px 0;
      font-weight: bold; letter-spacing: 0.05em;
    }

    /* ä»Šå¤œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡Œ */
    .schedule-item {
      display: flex; align-items: flex-start; gap: 15px;
      padding: 12px 15px; background: white;
      border-radius: 10px; margin-bottom: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .schedule-time {
      font-size: 1.1em; font-weight: bold;
      color: #667eea; min-width: 60px; padding-top: 1px;
    }
    .schedule-action { color: #333; line-height: 1.5; }

    /* ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ */
    .advice-card {
      background: white; border-radius: 10px;
      padding: 18px 20px; margin-bottom: 12px;
      border-left: 5px solid #667eea;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .advice-card h3 {
      color: #667eea; margin-bottom: 10px;
      display: flex; align-items: center; gap: 8px;
      font-size: 1em; flex-wrap: wrap;
    }
    .priority-badge {
      background: #667eea; color: white;
      padding: 3px 10px; border-radius: 20px;
      font-size: 0.75em; font-weight: normal;
    }
    .advice-action { font-weight: bold; color: #333; line-height: 1.5; }
    .advice-reason { margin-top: 8px; color: #666; font-size: 0.9em; line-height: 1.5; }

    /* ç¡çœ å“è³ªã‚¹ã‚³ã‚¢ */
    .prediction {
      text-align: center; padding: 20px;
      background: white; border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .prediction-score {
      font-size: 3.5em; font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .prediction-label { color: #999; font-size: 0.85em; margin-bottom: 5px; }
    .prediction-comment { color: #555; margin-top: 8px; line-height: 1.5; }

    /* åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .encouragement {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 20px;
      border-radius: 10px; margin-top: 15px;
      text-align: center; line-height: 1.8;
      font-size: 1.05em;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— */
    .section-title {
      color: #444; font-size: 1em; font-weight: bold;
      margin: 20px 0 12px; display: flex; align-items: center; gap: 8px;
    }

    /* ============================================================
       Gemini APIã‚­ãƒ¼è¨­å®šã‚¨ãƒªã‚¢
       ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã‚­ãƒ¼ã‚’åŸ‹ã‚è¾¼ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ãƒ»localStorageä¿å­˜ã™ã‚‹ã€‚
       ============================================================ */
    .api-key-section {
      background: #f0f4ff;
      border: 1.5px solid #b3c0f5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .api-key-section .section-title { margin-top: 0; }
    .api-key-hint {
      font-size: 0.85em;
      color: #555;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .api-key-hint a { color: #667eea; font-weight: bold; }
    /* å…¥åŠ›æ¬„ã¨ç›®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
    .api-key-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .api-key-input-wrap input {
      flex: 1;
      padding: 10px 12px;
      border: 1.5px solid #b3c0f5;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
      min-height: 44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ */
    }
    /* è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .api-key-toggle-btn {
      background: white;
      border: 1.5px solid #b3c0f5;
      border-radius: 8px;
      padding: 0 14px;
      cursor: pointer;
      font-size: 18px;
      min-height: 44px;
      min-width: 44px;
    }
    /* ä¿å­˜ãƒœã‚¿ãƒ³ */
    .api-key-save-btn {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      min-height: 48px;
      margin-bottom: 8px;
    }
    .api-key-save-btn:active { opacity: 0.8; }
    /* ä¿å­˜çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .api-key-status { font-size: 0.85em; text-align: center; min-height: 1.4em; }
    .api-key-ok  { color: #28a745; font-weight: bold; }
    .api-key-err { color: #dc3545; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">

    <!-- ã‚¢ãƒ—ãƒªã®ãƒ­ã‚´ã¨ã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="logo">ğŸŒ™</div>
    <h1>ç¡çœ ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥<br>ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒª</h1>
    <p class="subtitle" id="subtitle">ã‚ãªãŸã®ç¡çœ ã‚’ç§‘å­¦çš„ã«ã‚µãƒãƒ¼ãƒˆ</p>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ (åˆæœŸè¨­å®š / ä»Šæ—¥ã®è¨˜éŒ²) -->
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('setup')">âš™ï¸ åˆæœŸè¨­å®š</button>
      <button class="tab-btn" onclick="switchTab('daily')">ğŸ“ ä»Šæ—¥ã®è¨˜éŒ²</button>
    </div>

    <!-- ============================================================
         ã€ŒåˆæœŸè¨­å®šã€ã‚¿ãƒ–
         åå‰ãƒ»ç”Ÿå¹´æœˆæ—¥ãƒ»æ€§åˆ¥ãƒ»èº«é•·ãƒ»ä½“é‡ãƒ»è·æ¥­ãƒ»èµ·åºŠæ™‚åˆ»ãƒ»ç¡çœ ã®æ‚©ã¿ã‚’å…¥åŠ›ã€‚
         å…¥åŠ›å†…å®¹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã•ã‚Œã‚‹ï¼ˆã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—ï¼‰ã€‚
         ============================================================ -->
    <div id="setup-tab" class="tab-content active">

      <!-- ============================================================
           Gemini APIã‚­ãƒ¼è¨­å®šã‚¨ãƒªã‚¢
           APIã‚­ãƒ¼ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸ‹ã‚è¾¼ã¾ãšã€ã“ã“ã§å…¥åŠ›â†’localStorageã¸ä¿å­˜ã€‚
           GitHubã«å…¬é–‹ã—ã¦ã‚‚ã‚­ãƒ¼ãŒæ¼æ´©ã—ãªã„ã‚»ã‚­ãƒ¥ã‚¢ãªæ–¹å¼ã€‚
           ============================================================ -->
      <div class="api-key-section">
        <p class="section-title">ğŸ”‘ Gemini APIã‚­ãƒ¼è¨­å®š</p>
        <p class="api-key-hint">
          <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio</a>
          ã§å–å¾—ã—ãŸ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—ï¼‰ã€‚<br>
          <strong>âš ï¸ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã«ã¯å¿…é ˆã§ã™ã€‚</strong>
        </p>
        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å½¢å¼å…¥åŠ› + è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="api-key-input-wrap">
          <input type="password" id="api-key-input"
                 placeholder="AIzaSy..."
                 autocomplete="off"
                 spellcheck="false">
          <button type="button" class="api-key-toggle-btn"
                  onclick="toggleApiKeyVisibility()"
                  title="è¡¨ç¤º/éè¡¨ç¤º">ğŸ‘</button>
        </div>
        <button type="button" class="api-key-save-btn" onclick="saveApiKey()">
          ğŸ”‘ APIã‚­ãƒ¼ã‚’ä¿å­˜
        </button>
        <!-- ä¿å­˜çµæœã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="api-key-status" class="api-key-status"></div>
      </div>

      <div class="info-box" id="setup-info-box">
        ğŸ’¡ åˆå›ã®ã¿åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </div>

      <form id="basic-form">

        <!-- åå‰ -->
        <div class="form-group">
          <label for="name">ãŠåå‰<span class="required">*</span></label>
          <input type="text" id="name" required placeholder="å±±ç”°å¤ªéƒ">
        </div>

        <!-- ç”Ÿå¹´æœˆæ—¥ (å¹´é½¢è¨ˆç®—ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ç²¾åº¦ã‚’ä¸Šã’ã‚‹) -->
        <div class="form-group">
          <label for="birthdate">ç”Ÿå¹´æœˆæ—¥<span class="required">*</span></label>
          <input type="date" id="birthdate" required>
        </div>

        <!-- æ€§åˆ¥ -->
        <div class="form-group">
          <label for="gender">æ€§åˆ¥<span class="required">*</span></label>
          <select id="gender" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <!-- èº«é•· (BMIç®—å‡ºãªã©ã«æ´»ç”¨) -->
        <div class="form-group">
          <label for="height">èº«é•·ï¼ˆcmï¼‰<span class="required">*</span></label>
          <input type="number" id="height" required min="100" max="250" placeholder="170">
        </div>

        <!-- ä½“é‡ -->
        <div class="form-group">
          <label for="weight">ä½“é‡ï¼ˆkgï¼‰<span class="required">*</span></label>
          <input type="number" id="weight" required min="30" max="200" step="0.1" placeholder="60.5">
        </div>

        <!-- è·æ¥­ãƒ»å­¦å¹´ (ç”Ÿæ´»ãƒªã‚ºãƒ ã®æ¨å®šã«ä½¿ç”¨) -->
        <div class="form-group">
          <label for="occupation">è·æ¥­ / å­¦å¹´<span class="required">*</span></label>
          <select id="occupation" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å¤§å­¦ç”Ÿï¼ˆ1-2å¹´ï¼‰">å¤§å­¦ç”Ÿï¼ˆ1-2å¹´ï¼‰</option>
            <option value="å¤§å­¦ç”Ÿï¼ˆ3-4å¹´ï¼‰">å¤§å­¦ç”Ÿï¼ˆ3-4å¹´ï¼‰</option>
            <option value="å¤§å­¦é™¢ç”Ÿ">å¤§å­¦é™¢ç”Ÿ</option>
            <option value="ä¼šç¤¾å“¡">ä¼šç¤¾å“¡</option>
            <option value="ç ”ç©¶è€…ãƒ»æ•™å“¡">ç ”ç©¶è€…ãƒ»æ•™å“¡</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <!-- æ™®æ®µã®èµ·åºŠæ™‚åˆ» (ã‚µãƒ¼ã‚«ãƒ‡ã‚£ã‚¢ãƒ³ãƒªã‚ºãƒ ã®åŸºæº–) -->
        <div class="form-group">
          <label for="avgWakeTime">æ™®æ®µã®èµ·åºŠæ™‚åˆ»<span class="required">*</span></label>
          <input type="time" id="avgWakeTime" required value="07:00">
        </div>

        <!-- ç¡çœ ã®æ‚©ã¿ (è¤‡æ•°é¸æŠå¯) -->
        <div class="form-group">
          <label>ç¡çœ ã®æ‚©ã¿ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" name="concerns" value="å¯ä»˜ããŒæ‚ªã„">å¯ä»˜ããŒæ‚ªã„
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="concerns" value="å¤œä¸­ã«ç›®ãŒè¦šã‚ã‚‹">å¤œä¸­ã«ç›®ãŒè¦šã‚ã‚‹
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="concerns" value="ç†Ÿç¡æ„ŸãŒãªã„">ç†Ÿç¡æ„ŸãŒãªã„
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="concerns" value="æœèµ·ãã‚‰ã‚Œãªã„">æœèµ·ãã‚‰ã‚Œãªã„
            </label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" id="save-basic-btn">
          ğŸ’¾ ä¿å­˜ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
      </form>
    </div>

    <!-- ============================================================
         ã€Œä»Šæ—¥ã®è¨˜éŒ²ã€ã‚¿ãƒ–
         ä»Šæ—¥ã®ç”Ÿæ´»è¡Œå‹•ï¼ˆèµ·åºŠãƒ»é£Ÿäº‹ãƒ»é‹å‹•ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãªã©ï¼‰ã‚’å…¥åŠ›ã—ã€
         ã€ŒAIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ Gemini API ã‚’å‘¼ã³å‡ºã™ã€‚
         ============================================================ -->
    <div id="daily-tab" class="tab-content">

      <div class="info-box">
        ğŸ“ ä»Šæ—¥ã®æ´»å‹•ã‚’æŒ¯ã‚Šè¿”ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        AI ãŒä»Šå¤œã®æœ€é©ãªç¡çœ ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¾ã™ã€‚
      </div>

      <form id="daily-form">

        <!-- ä»Šæ—¥ã®èµ·åºŠæ™‚åˆ» -->
        <div class="form-group">
          <label for="wakeTime">ä»Šæ—¥ã®èµ·åºŠæ™‚åˆ»<span class="required">*</span></label>
          <input type="time" id="wakeTime" required>
        </div>

        <!-- æœé£Ÿ (é£Ÿã¹ãŸå ´åˆã¯æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ è¡¨ç¤º) -->
        <div class="form-group">
          <label for="breakfast">æœé£Ÿ<span class="required">*</span></label>
          <select id="breakfast" required onchange="toggleBreakfastTime()">
            <option value="é£Ÿã¹ãŸ">é£Ÿã¹ãŸ</option>
            <option value="è»½ãé£Ÿã¹ãŸ">è»½ãé£Ÿã¹ãŸ</option>
            <option value="é£Ÿã¹ãªã‹ã£ãŸ">é£Ÿã¹ãªã‹ã£ãŸ</option>
          </select>
        </div>

        <!-- æœé£Ÿæ™‚åˆ» (æœé£Ÿã‚’é£Ÿã¹ãŸå ´åˆã®ã¿è¡¨ç¤º) -->
        <div class="form-group" id="breakfast-time-group">
          <label for="breakfastTime">æœé£Ÿæ™‚åˆ»</label>
          <input type="time" id="breakfastTime">
        </div>

        <!-- æ—¥ä¸­ã®é‹å‹•é‡ -->
        <div class="form-group">
          <label for="exercise">æ—¥ä¸­ã®é‹å‹•<span class="required">*</span></label>
          <select id="exercise" required>
            <option value="ã»ã¨ã‚“ã©å‹•ã‹ãªã‹ã£ãŸ">ã»ã¨ã‚“ã©å‹•ã‹ãªã‹ã£ãŸ</option>
            <option value="é€šå‹¤ãƒ»é€šå­¦ç¨‹åº¦">é€šå‹¤ãƒ»é€šå­¦ç¨‹åº¦</option>
            <option value="è»½ã„é‹å‹•ï¼ˆ20ã€œ30åˆ†ï¼‰">è»½ã„é‹å‹•ï¼ˆ20ã€œ30åˆ†ï¼‰</option>
            <option value="ã—ã£ã‹ã‚Šé‹å‹•ï¼ˆ30åˆ†ä»¥ä¸Šï¼‰">ã—ã£ã‹ã‚Šé‹å‹•ï¼ˆ30åˆ†ä»¥ä¸Šï¼‰</option>
          </select>
        </div>

        <!-- ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å– (æ‘‚å–ã—ãŸå ´åˆã¯æœ€çµ‚æ™‚åˆ»ã‚’è¿½åŠ è¡¨ç¤º) -->
        <div class="form-group">
          <label for="caffeine">ã‚«ãƒ•ã‚§ã‚¤ãƒ³<span class="required">*</span></label>
          <select id="caffeine" required onchange="toggleCaffeineTime()">
            <option value="æ‘‚å–ã—ã¦ã„ãªã„">æ‘‚å–ã—ã¦ã„ãªã„</option>
            <option value="åˆå‰ä¸­ã®ã¿">åˆå‰ä¸­ã®ã¿</option>
            <option value="15æ™‚å‰ã¾ã§">15æ™‚å‰ã¾ã§</option>
            <option value="15æ™‚ä»¥é™ã‚‚">15æ™‚ä»¥é™ã‚‚</option>
          </select>
        </div>

        <!-- æœ€çµ‚ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å–æ™‚åˆ» (æ‘‚å–ã—ãŸå ´åˆã®ã¿è¡¨ç¤º) -->
        <div class="form-group" id="caffeine-time-group" style="display:none;">
          <label for="caffeineTime">æœ€çµ‚ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ™‚åˆ»</label>
          <input type="time" id="caffeineTime">
        </div>

        <!-- æ˜¼å¯ã®æœ‰ç„¡ (ã—ãŸå ´åˆã¯æ™‚é–“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ è¡¨ç¤º) -->
        <div class="form-group">
          <label for="nap">æ˜¼å¯<span class="required">*</span></label>
          <select id="nap" required onchange="toggleNapDuration()">
            <option value="ã—ã¦ã„ãªã„">ã—ã¦ã„ãªã„</option>
            <option value="ã—ãŸï¼ˆ30åˆ†æœªæº€ï¼‰">ã—ãŸï¼ˆ30åˆ†æœªæº€ï¼‰</option>
            <option value="ã—ãŸï¼ˆ30åˆ†ä»¥ä¸Šï¼‰">ã—ãŸï¼ˆ30åˆ†ä»¥ä¸Šï¼‰</option>
          </select>
        </div>

        <!-- æ˜¼å¯æ™‚é–“ (æ˜¼å¯ã—ãŸå ´åˆã®ã¿è¡¨ç¤º) -->
        <div class="form-group" id="nap-duration-group" style="display:none;">
          <label for="napDuration">æ˜¼å¯æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <input type="number" id="napDuration" min="0" max="180" placeholder="20">
        </div>

        <!-- å¤•é£Ÿæ™‚åˆ» (å°±å¯æ™‚åˆ»ã¨ã®é–“éš”è¨ˆç®—ã«ä½¿ç”¨) -->
        <div class="form-group">
          <label for="dinnerTime">å¤•é£Ÿæ™‚åˆ»<span class="required">*</span></label>
          <input type="time" id="dinnerTime" required>
        </div>

        <!-- å¤•é£Ÿå†…å®¹ (æ¶ˆåŒ–æ™‚é–“ã®æ¨å®šã«ä½¿ç”¨) -->
        <div class="form-group">
          <label for="dinnerContent">å¤•é£Ÿã®å†…å®¹<span class="required">*</span></label>
          <select id="dinnerContent" required>
            <option value="è»½ã‚">è»½ã‚</option>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="ã‚„ã‚„å¤šã‚">ã‚„ã‚„å¤šã‚</option>
            <option value="æ²¹ã£ã“ã„ãƒ»è‚‰ä¸­å¿ƒ">æ²¹ã£ã“ã„ãƒ»è‚‰ä¸­å¿ƒ</option>
          </select>
        </div>

        <!-- å¤•æ–¹ä»¥é™ã®é‹å‹• (ä½“æ¸©ãƒ»è¦šé†’åº¦ã¸ã®å½±éŸ¿ã‚’è€ƒæ…®) -->
        <div class="form-group">
          <label for="eveningExercise">å¤•æ–¹ä»¥é™ã®é‹å‹•<span class="required">*</span></label>
          <select id="eveningExercise" required>
            <option value="ã—ã¦ã„ãªã„">ã—ã¦ã„ãªã„</option>
            <option value="è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒ">è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒ</option>
            <option value="æ•£æ­©">æ•£æ­©</option>
            <option value="ã‚¸ãƒ§ã‚®ãƒ³ã‚°ãƒ»ç­‹ãƒˆãƒ¬">ã‚¸ãƒ§ã‚®ãƒ³ã‚°ãƒ»ç­‹ãƒˆãƒ¬</option>
          </select>
        </div>

        <!-- ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«: 1ã€œ5ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
        <div class="form-group">
          <label>ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«<span class="required">*</span></label>
          <div class="range-group">
            <span style="color:#666;font-size:0.85em;">ä½</span>
            <input type="range" id="stress" min="1" max="5" value="3"
                   oninput="updateRange('stress')">
            <span style="color:#666;font-size:0.85em;">é«˜</span>
            <span class="range-value" id="stress-value">3</span>
          </div>
        </div>

        <!-- ç–²åŠ´æ„Ÿ: 1ã€œ5ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
        <div class="form-group">
          <label>ç–²åŠ´æ„Ÿ<span class="required">*</span></label>
          <div class="range-group">
            <span style="color:#666;font-size:0.85em;">å…ƒæ°—</span>
            <input type="range" id="fatigue" min="1" max="5" value="3"
                   oninput="updateRange('fatigue')">
            <span style="color:#666;font-size:0.85em;">ç–²ã‚ŒãŸ</span>
            <span class="range-value" id="fatigue-value">3</span>
          </div>
        </div>

        <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆãƒœã‚¿ãƒ³ -->
        <button type="submit" class="btn btn-primary" id="generate-btn">
          ğŸ’¡ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ
        </button>
      </form>

      <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ (ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã«å‹•çš„ã«ç”Ÿæˆ) -->
      <div id="advice-display" style="display:none;"></div>

    </div><!-- /#daily-tab -->

  </div><!-- /.container -->

  <!-- ============================================================
       JavaScript: ã‚¢ãƒ—ãƒªã®å…¨å‹•ä½œãƒ­ã‚¸ãƒƒã‚¯
       ============================================================ -->
  <script>
    // ============================================================
    // Gemini API è¨­å®š
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ Gemini REST API ã‚’å‘¼ã³å‡ºã™ã€‚
    // Python ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ä¸è¦ã€‚
    // ============================================================

    /**
     * Gemini API ã‚­ãƒ¼ã€‚
     * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯åŸ‹ã‚è¾¼ã¾ãªã„ã€‚
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒåˆæœŸè¨­å®šã€ã‚¿ãƒ–ã«å…¥åŠ›ã—ãŸå€¤ã‚’ localStorage ã«ä¿å­˜ã—ã€
     * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¾©å…ƒã™ã‚‹ã€‚
     * APIã‚­ãƒ¼ã¯ https://aistudio.google.com/apikey ã§å–å¾—ã§ãã‚‹ã€‚
     */
    let GEMINI_API_KEY = localStorage.getItem('geminiApiKey') || '';

    /**
     * ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«åã€‚
     * gemini-2.5-flash: 2025å¹´ä»¥é™ã®æ¨å¥¨ãƒ¢ãƒ‡ãƒ«ï¼ˆgemini-2.0-flash ã®å¾Œç¶™ï¼‰
     * gemini-2.0-flash ã¯æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«æä¾›çµ‚äº†ã®ãŸã‚ 2.5-flash ã‚’ä½¿ç”¨ã€‚
     */
    const GEMINI_MODEL = 'gemini-2.5-flash';

    // â€» GEMINI_API_URL ã¯ callGeminiAPI å†…ã§å‹•çš„ã«ç”Ÿæˆã™ã‚‹ã€‚
    //   (APIã‚­ãƒ¼ãŒä¿å­˜å¾Œã«å³åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã€æ¯å› GEMINI_API_KEY ã‚’å‚ç…§ã—ã¦æ§‹ç¯‰ã™ã‚‹)


    // ============================================================
    // JSONã‚µãƒ‹ã‚¿ã‚¤ã‚¶
    // ============================================================

    /**
     * Gemini ãŒ JSON æ–‡å­—åˆ—å€¤ã®ä¸­ã«ç”Ÿã®åˆ¶å¾¡æ–‡å­—ï¼ˆæ”¹è¡Œãƒ»å¾©å¸°ãƒ»ã‚¿ãƒ–ï¼‰ã‚’
     * ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã›ãšã«å‡ºåŠ›ã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚ãã‚Œã‚’ JSON.parse ãŒæ‹’å¦ã™ã‚‹ãŸã‚ã€
     * 1æ–‡å­—ãšã¤èµ°æŸ»ã—ã¦ã€ŒJSONæ–‡å­—åˆ—å†…éƒ¨ã«ã‚ã‚‹åˆ¶å¾¡æ–‡å­—ã ã‘ã€ã‚’
     * æ­£ã—ã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—è¡¨ç¾ï¼ˆ\\n / \\r / \\tï¼‰ã«å¤‰æ›ã™ã‚‹ã€‚
     *
     * @param {string} text - Gemini ã‹ã‚‰å—ã‘å–ã£ãŸç”Ÿã® JSON ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string}    - åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãŸ JSON ãƒ†ã‚­ã‚¹ãƒˆ
     */
    function sanitizeJsonControlChars(text) {
      let result   = '';
      let inString = false; // ç¾åœ¨ JSON æ–‡å­—åˆ—ã®å†…å´ã«ã„ã‚‹ã‹
      let escaped  = false; // ç›´å‰ã®æ–‡å­—ãŒ \ ã ã£ãŸã‹

      for (let i = 0; i < text.length; i++) {
        const c = text[i];

        if (escaped) {
          // ç›´å‰ãŒ \ ãªã®ã§ã“ã®æ–‡å­—ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿ â†’ ãã®ã¾ã¾å‡ºåŠ›
          result  += c;
          escaped  = false;
          continue;
        }

        if (c === '\\' && inString) {
          // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®é–‹å§‹
          escaped = true;
          result += c;
          continue;
        }

        if (c === '"') {
          // æ–‡å­—åˆ—ã®é–‹å§‹ / çµ‚äº†ã‚’åˆ‡ã‚Šæ›¿ãˆ
          inString = !inString;
          result += c;
          continue;
        }

        if (inString) {
          // æ–‡å­—åˆ—å†…ã®ç”Ÿã®åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          if (c === '\n') { result += '\\n'; continue; }
          if (c === '\r') { result += '\\r'; continue; }
          if (c === '\t') { result += '\\t'; continue; }
        }

        result += c;
      }

      return result;
    }


    // ============================================================
    // JSONä¿®å¾©ï¼ˆé€”ä¸­ã§åˆ‡ã‚ŒãŸJSONã‚’è‡ªå‹•è£œå®Œã™ã‚‹ï¼‰
    // ============================================================

    /**
     * Gemini ã®å¿œç­”ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦JSONãŒä¸å®Œå…¨ãªå ´åˆã«è‡ªå‹•è£œå®Œã™ã‚‹ã€‚
     *
     * ä»•çµ„ã¿:
     *   1æ–‡å­—ãšã¤èµ°æŸ»ã—ã¦é–‹ã„ã¦ã„ã‚‹æ–‡å­—åˆ—ãƒ»é…åˆ—ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½è·¡ã—ã€
     *   ãƒ†ã‚­ã‚¹ãƒˆæœ«å°¾ã§é–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’è£œå®Œã—ã¦ valid JSON ã«è¿‘ã¥ã‘ã‚‹ã€‚
     *
     * ä¾‹:
     *   å…¥åŠ›: '{"greeting":"ãŠã¯ã‚ˆã†","today_summary":"ä»Šæ—¥ã¯'
     *   è£œå®Œ: '{"greeting":"ãŠã¯ã‚ˆã†","today_summary":"ä»Šæ—¥ã¯"}'
     *
     * @param {string} text - é€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ JSON ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string}    - è£œå®Œå¾Œã® JSON ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰
     */
    function repairTruncatedJson(text) {
      let inString = false;
      let escaped  = false;
      const stack  = []; // é–‹ã„ã¦ã„ã‚‹ { ã¾ãŸã¯ [ ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã§ç®¡ç†

      for (let i = 0; i < text.length; i++) {
        const c = text[i];

        if (escaped)          { escaped = false; continue; }
        if (c === '\\' && inString) { escaped = true;  continue; }

        if (c === '"') {
          inString = !inString;
          continue;
        }

        if (!inString) {
          if      (c === '{') stack.push('}');
          else if (c === '[') stack.push(']');
          else if (c === '}' || c === ']') stack.pop();
        }
      }

      let repaired = text;

      // æ–‡å­—åˆ—ã®é€”ä¸­ã§çµ‚ã‚ã£ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
      if (inString) repaired += '"';

      // æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’é™¤å»ï¼ˆä¸å®Œå…¨ãªè¦ç´ ãŒé€”ä¸­ã§åˆ‡ã‚ŒãŸå ´åˆï¼‰
      repaired = repaired.replace(/,\s*$/, '');

      // é–‹ã„ãŸã¾ã¾ã®é…åˆ—ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€†é †ã§é–‰ã˜ã‚‹
      while (stack.length > 0) repaired += stack.pop();

      return repaired;
    }


    // ============================================================
    // Gemini APIã‚­ãƒ¼ç®¡ç†
    // ============================================================

    /**
     * å…¥åŠ›æ¬„ã«å…¥åŠ›ã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’ localStorage ã«ä¿å­˜ã—ã€
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° GEMINI_API_KEY ã‚’æ›´æ–°ã™ã‚‹ã€‚
     * ã‚­ãƒ¼ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
     */
    function saveApiKey() {
      const input = document.getElementById('api-key-input');
      const status = document.getElementById('api-key-status');
      const key = input.value.trim();

      if (!key) {
        status.className = 'api-key-status api-key-err';
        status.textContent = 'âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return;
      }
      if (!key.startsWith('AIza')) {
        status.className = 'api-key-status api-key-err';
        status.textContent = 'âŒ ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚ã€ŒAIzaSy...ã€ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return;
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ localStorage ã‚’æ›´æ–°
      GEMINI_API_KEY = key;
      localStorage.setItem('geminiApiKey', key);

      // ä¿å­˜æˆåŠŸã‚’è¡¨ç¤º
      status.className = 'api-key-status api-key-ok';
      status.textContent = 'âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚';
    }

    /**
     * APIã‚­ãƒ¼å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å½¢å¼ï¼ˆâ—â—â—ï¼‰ã¨å¹³æ–‡ã‚’äº¤äº’ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
     */
    function toggleApiKeyVisibility() {
      const input = document.getElementById('api-key-input');
      input.type = (input.type === 'password') ? 'text' : 'password';
    }


    // ============================================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    // ============================================================

    /**
     * ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
     * å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ãƒ»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ 'active' ã‚’é™¤å»ã—ã€æŒ‡å®šã‚¿ãƒ–ã«ä»˜ä¸ã™ã‚‹ã€‚
     *
     * @param {string} tab - åˆ‡ã‚Šæ›¿ãˆå…ˆ ('setup' ã¾ãŸã¯ 'daily')
     */
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      if (tab === 'setup') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('setup-tab').classList.add('active');
      } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('daily-tab').classList.add('active');
        // åŸºæœ¬æƒ…å ±æœªç™»éŒ²ã®å ´åˆã¯åˆæœŸè¨­å®šã‚¿ãƒ–ã¸æˆ»ã™
        if (!checkBasicInfo()) return;
      }
    }


    // ============================================================
    // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    // ============================================================

    /**
     * æœé£Ÿé¸æŠã«å¿œã˜ã¦æœé£Ÿæ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     * ã€Œé£Ÿã¹ãªã‹ã£ãŸã€é¸æŠæ™‚ã¯éè¡¨ç¤ºã«ã—ã¦å€¤ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚
     */
    function toggleBreakfastTime() {
      const hide = document.getElementById('breakfast').value === 'é£Ÿã¹ãªã‹ã£ãŸ';
      document.getElementById('breakfast-time-group').style.display = hide ? 'none' : 'block';
      if (hide) document.getElementById('breakfastTime').value = '';
    }

    /**
     * ã‚«ãƒ•ã‚§ã‚¤ãƒ³é¸æŠã«å¿œã˜ã¦æœ€çµ‚æ‘‚å–æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     * ã€Œæ‘‚å–ã—ã¦ã„ãªã„ã€é¸æŠæ™‚ã¯éè¡¨ç¤ºã«ã—ã¦å€¤ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚
     */
    function toggleCaffeineTime() {
      const hide = document.getElementById('caffeine').value === 'æ‘‚å–ã—ã¦ã„ãªã„';
      document.getElementById('caffeine-time-group').style.display = hide ? 'none' : 'block';
      if (hide) document.getElementById('caffeineTime').value = '';
    }

    /**
     * æ˜¼å¯é¸æŠã«å¿œã˜ã¦æ˜¼å¯æ™‚é–“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     * ã€Œã—ã¦ã„ãªã„ã€é¸æŠæ™‚ã¯éè¡¨ç¤ºã«ã—ã¦å€¤ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚
     */
    function toggleNapDuration() {
      const hide = document.getElementById('nap').value === 'ã—ã¦ã„ãªã„';
      document.getElementById('nap-duration-group').style.display = hide ? 'none' : 'block';
      if (hide) document.getElementById('napDuration').value = '';
    }

    /**
     * ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§éš£ã®æ•°å€¤è¡¨ç¤ºã«åæ˜ ã™ã‚‹ã€‚
     *
     * @param {string} id - ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¦ç´ ã® id ('stress' ã¾ãŸã¯ 'fatigue')
     */
    function updateRange(id) {
      document.getElementById(id + '-value').textContent =
        document.getElementById(id).value;
    }


    // ============================================================
    // åŸºæœ¬æƒ…å ±ãƒã‚§ãƒƒã‚¯
    // ============================================================

    /**
     * localStorage ã«åŸºæœ¬æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
     * æœªç™»éŒ²ãªã‚‰è­¦å‘Šã‚’å‡ºã—ã¦åˆæœŸè¨­å®šã‚¿ãƒ–ã¸ç§»å‹•ã™ã‚‹ã€‚
     *
     * @returns {boolean} åŸºæœ¬æƒ…å ±ãŒå­˜åœ¨ã™ã‚Œã° true
     */
    function checkBasicInfo() {
      if (!localStorage.getItem('sleepAppBasicInfo')) {
        alert('å…ˆã«ã€ŒåˆæœŸè¨­å®šã€ã‚¿ãƒ–ã§åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        switchTab('setup');
        return false;
      }
      return true;
    }


    // ============================================================
    // Gemini API ã¸ã®å‘¼ã³å‡ºã—
    // ============================================================

    /**
     * Gemini REST API ã‚’å‘¼ã³å‡ºã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¯ä¸è¦ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™ã€‚
     *
     * @param {string} prompt - Gemini ã«é€ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—
     * @returns {Promise<string>} Gemini ãŒè¿”ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ
     * @throws {Error} APIã‚¨ãƒ©ãƒ¼ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚
     */
    async function callGeminiAPI(prompt) {
      // APIã‚­ãƒ¼ãŒæœªè¨­å®šã®å ´åˆã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™
      if (!GEMINI_API_KEY) {
        throw new Error(
          'Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n' +
          'ã€è¨­å®šæ‰‹é †ã€‘\n' +
          'â‘  ã€ŒåˆæœŸè¨­å®šã€ã‚¿ãƒ–ã‚’é–‹ã\n' +
          'â‘¡ ç”»é¢ä¸Šéƒ¨ã®ã€ŒğŸ”‘ Gemini APIã‚­ãƒ¼è¨­å®šã€æ¬„ã«ã‚­ãƒ¼ã‚’å…¥åŠ›\n' +
          'â‘¢ã€ŒAPIã‚­ãƒ¼ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™\n\n' +
          'APIã‚­ãƒ¼ã¯ https://aistudio.google.com/apikey ã§ç„¡æ–™å–å¾—ã§ãã¾ã™ã€‚'
        );
      }

      // APIã‚­ãƒ¼ã‚’æ¯å›å‹•çš„ã«URLã¸åŸ‹ã‚è¾¼ã‚€ï¼ˆä¿å­˜å¾Œã«å³åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ï¼‰
      const apiUrl =
        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

      // Gemini REST API ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã¯ { contents: [{ parts: [{ text: prompt }] }] } å½¢å¼
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          // ç”Ÿæˆè¨­å®š: JSONå½¢å¼ã®å‡ºåŠ›ã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          generationConfig: {
            temperature: 0.7,    // å‰µé€ æ€§ã¨å®‰å®šæ€§ã®ãƒãƒ©ãƒ³ã‚¹
            maxOutputTokens: 8192, // å¢—é‡: 2048ã§ã¯è¤‡é›‘ãªJSONãŒé€”ä¸­ã§åˆ‡ã‚Œã‚‹
            // â€» responseMimeType:'application/json' ã¯å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œå‹•æ™‚ã«
            //   ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚„ {} ã ã‘ã‚’è¿”ã™å•é¡ŒãŒã‚ã‚‹ãŸã‚ä½¿ç”¨ã—ãªã„ã€‚
            //   ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå´ã§JSONå‡ºåŠ›ã‚’æŒ‡ç¤ºã™ã‚‹æ–¹å¼ã§å¯¾å¿œã™ã‚‹ã€‚
          }
        }),
      });

      // HTTP ã‚¨ãƒ©ãƒ¼ (4xx, 5xx) ã‚’æ¤œå‡ºã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
      if (!response.ok) {
        const errBody = await response.json().catch(() => ({}));
        const errMsg = errBody?.error?.message || `HTTP ${response.status}`;

        // ã€Œreferer ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã€ã‚¨ãƒ©ãƒ¼ã¯ APIã‚­ãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ãŒåŸå› ã€‚
        // Google Cloud Console ã§ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨±å¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
        if (errMsg.includes('blocked') || errMsg.includes('referer') || errMsg.includes('referrer')) {
          throw new Error(
            `APIã‚­ãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã‚¨ãƒ©ãƒ¼\n\n` +
            `ã“ã®ã‚µã‚¤ãƒˆ (${location.hostname}) ãŒ Gemini API ã‚­ãƒ¼ã®è¨±å¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n` +
            `ã€ä¿®æ­£æ‰‹é †ã€‘\n` +
            `â‘  https://console.cloud.google.com/apis/credentials ã‚’é–‹ã\n` +
            `â‘¡ APIã‚­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯\n` +
            `â‘¢ã€Œã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®åˆ¶é™ã€ã«ä»¥ä¸‹ã‚’è¿½åŠ :\n` +
            `   https://${location.hostname}/*\n` +
            `â‘£ ä¿å­˜ã—ã¦æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ`
          );
        }

        throw new Error(`Gemini API ã‚¨ãƒ©ãƒ¼: ${errMsg}`);
      }

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã¨çµ‚äº†ç†ç”±ã‚’å–ã‚Šå‡ºã™
      const data         = await response.json();
      const candidate    = data?.candidates?.[0];

      // â–¼ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: parts[0] ã ã‘ã§ãªãå…¨ parts ã‚’çµåˆã™ã‚‹ã€‚
      // Gemini ã¯é•·ã„å¿œç­”ã‚’è¤‡æ•°ã® parts ã«åˆ†å‰²ã—ã¦è¿”ã™ã“ã¨ãŒã‚ã‚‹ã€‚
      // parts[0] ã®ã¿å–å¾—ã—ã¦ã„ã‚‹ã¨é€”ä¸­ã§ãƒ†ã‚­ã‚¹ãƒˆãŒåˆ‡ã‚Œ
      // "Unterminated string" ã‚„ "Unexpected end of JSON" ã®åŸå› ã«ãªã‚‹ã€‚
      const parts        = candidate?.content?.parts || [];
      const text         = parts.map(p => p.text ?? '').join('');
      const finishReason = candidate?.finishReason;

      // ãƒ‡ãƒãƒƒã‚°: çµ‚äº†ç†ç”±ãƒ»partsæ•°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆå†’é ­ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('Gemini finishReason:', finishReason);
      console.log('Gemini parts count:', parts.length);
      console.log('Gemini text å…¨é•·:', text.length, 'å­—');
      console.log('Gemini text (å…ˆé ­300å­—):', text.slice(0, 300));

      // STOP ä»¥å¤–ã®çµ‚äº†ç†ç”±ã¯ã™ã¹ã¦å•é¡Œã‚ã‚Šã¨ã—ã¦å€‹åˆ¥ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™
      const finishReasonMessages = {
        MAX_TOKENS  : 'ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ã«é”ã—ãŸãŸã‚å¿œç­”ãŒé€”ä¸­ã§åˆ‡ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        SAFETY      : 'å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šå¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’å¤‰æ›´ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        RECITATION  : 'è‘—ä½œæ¨©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šå¿œç­”ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        OTHER       : 'ä¸æ˜ãªç†ç”±ã§å¿œç­”ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        BLOCKLIST   : 'ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šå¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚',
        PROHIBITED_CONTENT: 'ç¦æ­¢ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦å¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚',
        SPII        : 'ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æƒ…å ±ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‚ˆã‚Šå¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚',
      };
      if (finishReason && finishReason !== 'STOP') {
        const msg = finishReasonMessages[finishReason]
          || `å¿œç­”ãŒç•°å¸¸çµ‚äº†ã—ã¾ã—ãŸ (finishReason: ${finishReason})ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
        console.warn('Gemini ç•°å¸¸çµ‚äº†:', finishReason, data);
        throw new Error(msg);
      }

      if (!text) {
        console.warn('Gemini: ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:', JSON.stringify(data));
        throw new Error(
          'Gemini API ã‹ã‚‰æœ‰åŠ¹ãªãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n' +
          'ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚'
        );
      }

      return text;
    }


    // ============================================================
    // Gemini API ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
    // ============================================================

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸºæœ¬æƒ…å ±ã¨ä»Šæ—¥ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰
     * Gemini ã«é€ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€‚
     * JSON å½¢å¼ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿”ã™ã‚ˆã†æŒ‡ç¤ºã™ã‚‹ã€‚
     *
     * @param {Object} basicInfo - åŸºæœ¬æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Object} dailyData - ä»Šæ—¥ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {string} ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—
     */
    function buildGeminiPrompt(basicInfo, dailyData) {
      // â”€â”€ å¹´é½¢ã‚’ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰è¨ˆç®— â”€â”€
      let ageStr = 'ä¸æ˜';
      if (basicInfo.birthdate) {
        const birth = new Date(basicInfo.birthdate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        // ä»Šå¹´ã®èª•ç”Ÿæ—¥ãŒã¾ã ãªã‚‰ -1 ã—ã¦æ­£ç¢ºãªæº€å¹´é½¢ã‚’ç®—å‡º
        const hasNotBirthdayYet =
          today.getMonth() < birth.getMonth() ||
          (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate());
        if (hasNotBirthdayYet) age--;
        ageStr = `${age}`;
      }

      // â”€â”€ ç¡çœ ã®æ‚©ã¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ› â”€â”€
      const concerns = (basicInfo.sleepConcerns || []).join('ã€') || 'ç‰¹ã«ãªã—';

      // â”€â”€ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ¬æ–‡ã‚’æ§‹ç¯‰ â”€â”€
      return `
ã‚ãªãŸã¯ç¡çœ ç§‘å­¦ã«åŸºã¥ã„ãŸå°‚é–€ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ä»Šæ—¥ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸç¡çœ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’
**å¿…ãšä¸‹è¨˜ã® JSON å½¢å¼ã®ã¿** ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ï¼‰ã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
- åå‰     : ${basicInfo.name || ''}ã•ã‚“
- å¹´é½¢     : ${ageStr}æ­³
- æ€§åˆ¥     : ${basicInfo.gender || 'ä¸æ˜'}
- èº«é•·/ä½“é‡: ${basicInfo.height || ''}cm / ${basicInfo.weight || ''}kg
- è·æ¥­     : ${basicInfo.occupation || 'ä¸æ˜'}
- æ™®æ®µã®èµ·åºŠæ™‚åˆ»: ${basicInfo.avgWakeTime || 'ä¸æ˜'}
- ç¡çœ ã®æ‚©ã¿    : ${concerns}

## ä»Šæ—¥ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿
- èµ·åºŠæ™‚åˆ»       : ${dailyData.wakeTime || 'ä¸æ˜'}
- æœé£Ÿ           : ${dailyData.breakfast || 'ä¸æ˜'}ï¼ˆæ™‚åˆ»: ${dailyData.breakfastTime || 'ä¸æ˜'}ï¼‰
- æ—¥ä¸­ã®é‹å‹•     : ${dailyData.exercise || 'ä¸æ˜'}
- ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å– : ${dailyData.caffeine || 'ä¸æ˜'}ï¼ˆæœ€çµ‚: ${dailyData.caffeineTime || 'ä¸æ˜'}ï¼‰
- æ˜¼å¯           : ${dailyData.nap || 'ä¸æ˜'}ï¼ˆæ™‚é–“: ${dailyData.napDuration || 0}åˆ†ï¼‰
- å¤•é£Ÿæ™‚åˆ»       : ${dailyData.dinnerTime || 'ä¸æ˜'}
- å¤•é£Ÿå†…å®¹       : ${dailyData.dinnerContent || 'ä¸æ˜'}
- å¤•æ–¹ä»¥é™ã®é‹å‹• : ${dailyData.eveningExercise || 'ä¸æ˜'}
- ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ« : ${dailyData.stress || 3}/5
- ç–²åŠ´æ„Ÿ         : ${dailyData.fatigue || 3}/5

## è¿”ç­”å½¢å¼ (ã“ã®JSONã®ã¿è¿”ã™ã“ã¨)
{
  "greeting": "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€è¦ªã—ã¿ã‚„ã™ã„æŒ¨æ‹¶æ–‡",
  "today_summary": "ä»Šæ—¥ã®æ´»å‹•ã®è¦ç´„ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰",
  "recommended_bedtime": "æ¨å¥¨å°±å¯æ™‚åˆ»ï¼ˆä¾‹: 23:00ï¼‰",
  "sleep_schedule": [
    {"time": "æ™‚åˆ»ï¼ˆä¾‹: 21:00ï¼‰", "action": "ã“ã®æ™‚åˆ»ã«ã™ã¹ãè¡Œå‹•"},
    {"time": "æ™‚åˆ»", "action": "è¡Œå‹•"},
    {"time": "æ™‚åˆ»", "action": "è¡Œå‹•"},
    {"time": "å°±å¯æ™‚åˆ»", "action": "å°±å¯"}
  ],
  "priority_advice": [
    {
      "priority": 1,
      "icon": "é–¢é€£ã™ã‚‹çµµæ–‡å­—",
      "title": "ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«",
      "action": "å…·ä½“çš„ãªè¡Œå‹•æŒ‡ç¤º",
      "reason": "ç§‘å­¦çš„ãªç†ç”±ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰"
    },
    {"priority": 2, "icon": "çµµæ–‡å­—", "title": "ã‚¿ã‚¤ãƒˆãƒ«", "action": "è¡Œå‹•æŒ‡ç¤º", "reason": "ç†ç”±"},
    {"priority": 3, "icon": "çµµæ–‡å­—", "title": "ã‚¿ã‚¤ãƒˆãƒ«", "action": "è¡Œå‹•æŒ‡ç¤º", "reason": "ç†ç”±"}
  ],
  "sleep_prediction": {
    "quality_score": äºˆæ¸¬ç¡çœ ã‚¹ã‚³ã‚¢ï¼ˆ0ã€œ100ã®æ•´æ•°ï¼‰,
    "comment": "ç¡çœ å“è³ªã®äºˆæ¸¬ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ40æ–‡å­—ä»¥å†…ï¼‰"
  },
  "encouragement": "æ¸©ã‹ã„åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰"
}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯„ã‚Šæ·»ã£ãŸã€æ¸©ã‹ãå®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
`;
    }


    // ============================================================
    // åˆæœŸè¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
    // ============================================================

    document.getElementById('basic-form').addEventListener('submit', function(e) {
      e.preventDefault(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã•ã‚ŒãŸç¡çœ ã®æ‚©ã¿ã‚’é…åˆ—ã¨ã—ã¦åé›†
      const concerns = Array.from(
        document.querySelectorAll('input[name="concerns"]:checked')
      ).map(cb => cb.value);

      // ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›å€¤ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹
      const data = {
        name         : document.getElementById('name').value,
        birthdate    : document.getElementById('birthdate').value,
        gender       : document.getElementById('gender').value,
        height       : parseFloat(document.getElementById('height').value),
        weight       : parseFloat(document.getElementById('weight').value),
        occupation   : document.getElementById('occupation').value,
        avgWakeTime  : document.getElementById('avgWakeTime').value,
        sleepConcerns: concerns,
      };

      // ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã™ã‚‹ï¼ˆã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã¯è¡Œã‚ãªã„ï¼‰
      localStorage.setItem('sleepAppBasicInfo', JSON.stringify(data));

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€1.5ç§’å¾Œã«ã€Œä»Šæ—¥ã®è¨˜éŒ²ã€ã‚¿ãƒ–ã¸ç§»å‹•
      const infoBox = document.getElementById('setup-info-box');
      infoBox.className = 'success-box';
      infoBox.textContent = `âœ… ${data.name}ã•ã‚“ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ä»Šæ—¥ã®è¨˜éŒ²ã‚¿ãƒ–ã¸ç§»å‹•ã—ã¾ã™ã€‚`;

      setTimeout(() => switchTab('daily'), 1500);
    });


    // ============================================================
    // ä»Šæ—¥ã®è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç† (AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ)
    // ============================================================

    document.getElementById('daily-form').addEventListener('submit', async function(e) {
      e.preventDefault(); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã

      // localStorage ã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’å–å¾— (æœªç™»éŒ²ãªã‚‰ä¸­æ–­)
      const basicInfo = JSON.parse(localStorage.getItem('sleepAppBasicInfo'));
      if (!basicInfo) {
        alert('å…ˆã«åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        switchTab('setup');
        return;
      }

      // ä»Šæ—¥ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰åé›†
      const dailyData = {
        wakeTime       : document.getElementById('wakeTime').value,
        breakfast      : document.getElementById('breakfast').value,
        breakfastTime  : document.getElementById('breakfastTime').value,
        exercise       : document.getElementById('exercise').value,
        caffeine       : document.getElementById('caffeine').value,
        caffeineTime   : document.getElementById('caffeineTime').value,
        nap            : document.getElementById('nap').value,
        napDuration    : parseInt(document.getElementById('napDuration').value) || 0,
        dinnerTime     : document.getElementById('dinnerTime').value,
        dinnerContent  : document.getElementById('dinnerContent').value,
        eveningExercise: document.getElementById('eveningExercise').value,
        stress         : parseInt(document.getElementById('stress').value),
        fatigue        : parseInt(document.getElementById('fatigue').value),
      };

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
      const btn = document.getElementById('generate-btn');
      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';

      const display = document.getElementById('advice-display');
      display.style.display = 'block';
      display.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>ğŸ¤– AI ãŒç¡çœ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’<br>ç”Ÿæˆã—ã¦ã„ã¾ã™...<br>
          <small style="color:#999;">ï¼ˆ10ã€œ20ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</small></p>
        </div>`;

      // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      display.scrollIntoView({ behavior: 'smooth', block: 'start' });

      try {
        // â”€â”€ Gemini API å‘¼ã³å‡ºã— â”€â”€
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ã—ã¦ Gemini ã«é€ä¿¡ã™ã‚‹
        const prompt = buildGeminiPrompt(basicInfo, dailyData);
        const rawText = await callGeminiAPI(prompt);

        // â”€â”€ JSON è§£æ â”€â”€
        // responseMimeType:'application/json' æŒ‡å®šæ™‚ã¯ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ã ãŒå¿µã®ãŸã‚é™¤å»ã€‚
        // Gemini ãŒç¨€ã« ```json ... ``` ã§å›²ã‚“ã§è¿”ã™å ´åˆã‚‚å¯¾å¿œã™ã‚‹ã€‚
        let jsonText = rawText.trim();
        // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é™¤å»ï¼ˆå…ˆé ­ãƒ»æœ«å°¾ï¼‰
        jsonText = jsonText.replace(/^```(?:json)?\s*\n?/i, '').replace(/\n?```\s*$/i, '');
        // å…ˆé ­ã® { ã¾ãŸã¯ [ ä»¥å‰ã®ä½™åˆ†ãªãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Œã°é™¤å»
        const jsonStart = jsonText.search(/[{[]/);
        if (jsonStart > 0) jsonText = jsonText.slice(jsonStart);

        // â”€â”€ Step1: JSONã‚µãƒ‹ã‚¿ã‚¤ã‚º â”€â”€
        // æ–‡å­—åˆ—å†…ã®ç”Ÿã®åˆ¶å¾¡æ–‡å­—ï¼ˆ\n \r \tï¼‰ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—è¡¨ç¾ã«å¤‰æ›
        jsonText = sanitizeJsonControlChars(jsonText);

        // â”€â”€ Step2: JSON ãƒ‘ãƒ¼ã‚¹ï¼ˆå¤±æ•—æ™‚ã¯è‡ªå‹•ä¿®å¾©ã—ã¦å†è©¦è¡Œï¼‰â”€â”€
        let advice;
        try {
          // ã¾ãšãã®ã¾ã¾ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
          advice = JSON.parse(jsonText);
        } catch (firstErr) {
          console.warn('JSON åˆå›ãƒ‘ãƒ¼ã‚¹å¤±æ•—:', firstErr.message);
          console.warn('ä¿®å¾©ã‚’è©¦ã¿ã¾ã™ã€‚å…ƒãƒ†ã‚­ã‚¹ãƒˆ:', jsonText);

          // å¤±æ•—ã—ãŸã‚‰é€”ä¸­ã§åˆ‡ã‚ŒãŸJSONã‚’è‡ªå‹•è£œå®Œã—ã¦å†ãƒ‘ãƒ¼ã‚¹
          try {
            const repaired = repairTruncatedJson(jsonText);
            console.log('ä¿®å¾©å¾Œãƒ†ã‚­ã‚¹ãƒˆ:', repaired);
            advice = JSON.parse(repaired);
            console.log('ä¿®å¾©ãƒ‘ãƒ¼ã‚¹æˆåŠŸ âœ…');
            // ä¿®å¾©æˆåŠŸã§ã‚‚ä¸€éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
            // displayAdvice å´ã§ undefined ã‚’è¨±å®¹ã™ã‚‹ã‚ˆã†å®Ÿè£…æ¸ˆã¿
          } catch (repairErr) {
            // ä¿®å¾©ã—ã¦ã‚‚ãƒ‘ãƒ¼ã‚¹ä¸èƒ½ãªå ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            const preview = rawText ? rawText.slice(0, 300) : '(ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹)';
            console.error('JSON ä¿®å¾©ãƒ‘ãƒ¼ã‚¹ã‚‚å¤±æ•—:', repairErr.message);
            console.error('Gemini ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:', rawText);
            throw new Error(
              `AIã®è¿”ç­”ã‚’JSONå½¢å¼ã§è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n` +
              `ã‚¨ãƒ©ãƒ¼: ${firstErr.message}\n\n` +
              `ã€å—ä¿¡ãƒ‡ãƒ¼ã‚¿å†’é ­ã€‘\n${preview}\n\n` +
              `ã‚‚ã†ä¸€åº¦ã€ŒAIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`
            );
          }
        }

        // ãƒ‘ãƒ¼ã‚¹ã«æˆåŠŸã—ãŸã‚‰ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”»é¢ã«è¡¨ç¤º
        displayAdvice(advice);

      } catch (err) {
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚: ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç”»é¢ã«è¡¨ç¤º
        display.innerHTML = `
          <div class="error-box">
            âŒ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>
            <strong>${err.message}</strong><br><br>
            <small>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</small>
          </div>`;
        console.error('Gemini API ã‚¨ãƒ©ãƒ¼:', err);

      } finally {
        // å‡¦ç†å®Œäº†å¾Œã€å¿…ãšãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        btn.disabled = false;
        btn.textContent = 'ğŸ’¡ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ';
      }
    });


    // ============================================================
    // ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤ºå‡¦ç†
    // ============================================================

    /**
     * Gemini ãŒè¿”ã—ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ HTML ã«å¤‰æ›ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚
     *
     * ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ :
     *   greeting          : æŒ¨æ‹¶æ–‡
     *   today_summary     : ä»Šæ—¥ã®è¦ç´„
     *   recommended_bedtime: æ¨å¥¨å°±å¯æ™‚åˆ»
     *   sleep_schedule    : ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…åˆ— [{time, action}]
     *   priority_advice   : å„ªå…ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹é…åˆ— [{priority, icon, title, action, reason}]
     *   sleep_prediction  : ç¡çœ äºˆæ¸¬ {quality_score, comment}
     *   encouragement     : åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     *
     * @param {Object} advice - Gemini ãŒç”Ÿæˆã—ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function displayAdvice(advice) {
      // â”€â”€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« HTML ã‚’ç”Ÿæˆ â”€â”€
      const scheduleHTML = (advice.sleep_schedule || []).map(s => `
        <div class="schedule-item">
          <div class="schedule-time">${s.time}</div>
          <div class="schedule-action">${s.action}</div>
        </div>`
      ).join('');

      // â”€â”€ å„ªå…ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ HTML ã‚’ç”Ÿæˆ â”€â”€
      const adviceHTML = (advice.priority_advice || []).map(adv => `
        <div class="advice-card">
          <h3>
            <span>${adv.icon || ''}</span>
            <span>${adv.title}</span>
            <span class="priority-badge">å„ªå…ˆåº¦ ${adv.priority}</span>
          </h3>
          <p class="advice-action">âœ… ${adv.action}</p>
          <p class="advice-reason">${adv.reason}</p>
        </div>`
      ).join('');

      // â”€â”€ ç¡çœ å“è³ªã‚¹ã‚³ã‚¢ HTML ã‚’ç”Ÿæˆ â”€â”€
      const predictionHTML = advice.sleep_prediction
        ? `<div class="prediction">
             <p class="prediction-label">ä»Šå¤œã®äºˆæ¸¬ç¡çœ å“è³ªã‚¹ã‚³ã‚¢</p>
             <div class="prediction-score">${advice.sleep_prediction.quality_score}ç‚¹</div>
             <p class="prediction-comment">${advice.sleep_prediction.comment}</p>
           </div>`
        : '';

      // â”€â”€ å…¨ä½“ã‚’ advice-display è¦ç´ ã«æŒ¿å…¥ â”€â”€
      document.getElementById('advice-display').innerHTML = `
        <div class="advice-container">
          <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: æŒ¨æ‹¶ã¨ä»Šæ—¥ã®ã‚µãƒãƒªãƒ¼ -->
          <div class="advice-header">
            <h2>${advice.greeting}</h2>
            <p style="margin-top:10px;opacity:0.9;">${advice.today_summary}</p>
          </div>

          <div class="advice-body">
            <!-- æ¨å¥¨å°±å¯æ™‚åˆ» -->
            <div class="bedtime">â° ${advice.recommended_bedtime}</div>

            <!-- ä»Šå¤œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <p class="section-title">ğŸ“… ä»Šå¤œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</p>
            ${scheduleHTML}

            <!-- å„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <p class="section-title" style="margin-top:25px;">ğŸ’¡ å„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</p>
            ${adviceHTML}

            <!-- ç¡çœ å“è³ªã‚¹ã‚³ã‚¢ -->
            ${predictionHTML}

            <!-- åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="encouragement">${advice.encouragement}</div>
          </div>
        </div>`;

      // ã‚¢ãƒ‰ãƒã‚¤ã‚¹å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.getElementById('advice-display').scrollIntoView({ behavior: 'smooth' });
    }


    // ============================================================
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸå‡¦ç†
    // ============================================================

    /**
     * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã« localStorage ã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã€
     * ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’å¾©å…ƒã—ã¦ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã€‚
     */
    window.onload = function() {

      // â”€â”€ APIã‚­ãƒ¼ã®å¾©å…ƒ â”€â”€
      // localStorage ã«ä¿å­˜æ¸ˆã¿ã®APIã‚­ãƒ¼ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åæ˜ ã™ã‚‹
      const savedApiKey = localStorage.getItem('geminiApiKey');
      if (savedApiKey) {
        GEMINI_API_KEY = savedApiKey;
        document.getElementById('api-key-input').value = savedApiKey;
        const status = document.getElementById('api-key-status');
        status.className = 'api-key-status api-key-ok';
        status.textContent = 'âœ… ä¿å­˜æ¸ˆã¿ã®APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚';
      }

      const basicInfo = JSON.parse(localStorage.getItem('sleepAppBasicInfo') || 'null');

      if (basicInfo) {
        // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼åå°‚ç”¨ã«å¤‰æ›´
        document.getElementById('subtitle').textContent =
          `${basicInfo.name}ã•ã‚“å°‚ç”¨ã®ç¡çœ ã‚¢ãƒ‰ãƒã‚¤ã‚¹`;

        // åˆæœŸè¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«ä¿å­˜æ¸ˆã¿ã®å€¤ã‚’å¾©å…ƒã™ã‚‹
        if (basicInfo.name)        document.getElementById('name').value        = basicInfo.name;
        if (basicInfo.birthdate)   document.getElementById('birthdate').value   = basicInfo.birthdate;
        if (basicInfo.gender)      document.getElementById('gender').value      = basicInfo.gender;
        if (basicInfo.height)      document.getElementById('height').value      = basicInfo.height;
        if (basicInfo.weight)      document.getElementById('weight').value      = basicInfo.weight;
        if (basicInfo.occupation)  document.getElementById('occupation').value  = basicInfo.occupation;
        if (basicInfo.avgWakeTime) document.getElementById('avgWakeTime').value = basicInfo.avgWakeTime;

        // ç¡çœ ã®æ‚©ã¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¾©å…ƒ
        (basicInfo.sleepConcerns || []).forEach(concern => {
          const cb = document.querySelector(
            `input[name="concerns"][value="${concern}"]`
          );
          if (cb) cb.checked = true;
        });

        // æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ã‚’ã€Œç™»éŒ²æ¸ˆã¿ã€æ¡ˆå†…ã«å¤‰æ›´
        const infoBox = document.getElementById('setup-info-box');
        infoBox.className = 'success-box';
        infoBox.textContent =
          `âœ… ${basicInfo.name}ã•ã‚“ã®æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯å†å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`;
      }
    };
  </script>
</body>
</html>
